@{
    Layout = null;
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Reset Password - Broker</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Favicon -->
    <link rel="shortcut icon" href="~/images/favicon.ico">


    <!-- Theme Config -->
    <script src="~/assets/js/config.js"></script>

    <!-- CSS -->
    <link href="~/assets/vendor/sweetalert2/sweetalert2.min.css" rel="stylesheet" />
    <link href="~/assets/css/app.min.css" rel="stylesheet" type="text/css" id="app-style" />
    <link href="~/assets/css/icons.min.css" rel="stylesheet" type="text/css" />
</head>

<body class="authentication-bg position-relative">

    <div class="account-pages pt-2 pt-sm-5 pb-4 pb-sm-5 position-relative">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-xxl-4 col-lg-4">
                    <div class="card overflow-hidden">
                        <div class="d-flex flex-column h-100">
                            <div class="auth-brand p-4 text-center">
                                <a href="index.html" class="logo-light">
                                    @* <img src="~/assets/images/logo.png" alt="logo" height="22"> *@
                                    <img src="~/images/logo-dark-2.png" alt="logo" style="height:80px">
                                </a>
                                <a href="index.html" class="logo-dark">
                                    @* <img src="~/assets/images/logo-dark.png" alt="dark logo" height="22"> *@
                                    <img src="~/images/logo-dark-2.png" alt="logo" style="height:80px">
                                </a>
                            </div>

                            <div class="p-4 my-auto">

                                <!-- STEP 1 : EMAIL -->
                                <div id="fp_step1">
                                    <h4 class="fs-20 mb-2 text-center">Reset Password</h4>
                                    <p class="text-muted text-center">Enter your registered email</p>

                                    <div class="mb-3">
                                        <label class="form-label">Email</label>
                                        <input type="email" id="fp_email" class="form-control"
                                               placeholder="Enter email">
                                    </div>

                                    <button type="button" id="fp_btn_sendotp"
                                            class="btn btn-soft-primary w-100">
                                        Send OTP
                                    </button>

                                    <div id="fp_msg1" class="text-danger mt-2"></div>
                                </div>

                                <!-- STEP 2 : OTP -->
                                <div id="fp_step2" style="display:none;">
                                    <h4 class="fs-20 mb-2 text-center">Verify OTP</h4>

                                    <div class="mb-3">
                                        <label class="form-label">OTP</label>
                                        <input type="text" id="fp_otp" maxlength="6"
                                               class="form-control" placeholder="Enter OTP">
                                    </div>

                                    <div id="fp_timerBlock" class="text-info mb-2">
                                        Resend OTP in: <span id="fp_timer">02:00</span>
                                    </div>

                                    <button type="button" id="fp_btn_resendotp"
                                            class="btn btn-link p-0 mb-3" disabled>
                                        Resend OTP
                                    </button>

                                    <button type="button" id="fp_btn_verifyotp"
                                            class="btn btn-success w-100">
                                        Verify OTP
                                    </button>

                                    <div id="fp_msg2" class="text-danger mt-2"></div>
                                </div>

                                <!-- STEP 3 : RESET PASSWORD -->
                                <div id="fp_step3" style="display:none;">
                                    <h4 class="fs-20 mb-2 text-center">Set New Password</h4>

                                    <div class="mb-3">
                                        <label class="form-label">New Password</label>
                                        <div class="input-group input-group-merge">
                                            <input type="password" id="fp_newpassword" class="form-control form-control-sm" placeholder="New password">
                                            <div class="input-group-text input-group-text-sm" data-password="true">
                                                <span class="password-eye"></span>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label float-start">Confirm Password</label>
                                        <div class="input-group input-group-merge">
                                            <input type="password" id="fp_confirmpassword" class="form-control form-control-sm" placeholder="Confirm password">
                                            <div class="input-group-text input-group-text-sm" data-password="true">
                                                <span class="password-eye"></span>
                                            </div>
                                        </div>
                                    </div>

                                    <button type="button" id="fp_btn_resetpw"
                                            class="btn btn-success w-100">
                                        Reset Password
                                    </button>

                                    <div id="fp_msg3" class="mt-2"></div>
                                </div>

                                <div class="text-center mt-3">
                                    <a href="@Url.Action("Account", "Home", new { area = "Admin" })"
                                       class="text-muted">
                                        Back to Login
                                    </a>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JS -->
    <script src="~/assets/js/vendor.min.js"></script>
    <script src="~/assets/vendor/sweetalert2/sweetalert2.min.js"></script>
    <script src="~/assets/js/app.min.js"></script>


    <script>
        let fp_timerRef;
        let fp_seconds = 120;

        function startTimer() {
            clearInterval(fp_timerRef);
            fp_seconds = 120;
            $("#fp_timer").text("02:00");

            fp_timerRef = setInterval(function () {
                let m = Math.floor(fp_seconds / 60);
                let s = fp_seconds % 60;

                $("#fp_timer").text(
                    m.toString().padStart(2, '0') + ":" +
                    s.toString().padStart(2, '0')
                );

                fp_seconds--;

                if (fp_seconds < 0) {
                    clearInterval(fp_timerRef);
                    $("#fp_btn_resendotp").prop("disabled", false);
                    $("#fp_timerBlock").hide();
                }
            }, 1000);
        }

        // SEND OTP
        $("#fp_btn_sendotp").click(function () {
            let email = $("#fp_email").val().trim();
            $("#fp_msg1").html("");

            if (email === "") {
                $("#fp_msg1").html("Please enter email");
                return;
            }

            $.post("/Admin/Home/ForgotPassword_SendOTP", { email: email }, function (res) {
                if (res.IsSuccess) {
                    $("#fp_step1").hide();
                    $("#fp_step2").show();
                    $("#fp_btn_resendotp").prop("disabled", true);
                    startTimer();
                } else {
                    $("#fp_msg1").html(res.Message);
                }
            });
        });

        // VERIFY OTP
        $("#fp_btn_verifyotp").click(function () {
            let otp = $("#fp_otp").val().trim();
            let email = $("#fp_email").val().trim();
            $("#fp_msg2").html("");

            if (otp === "") {
                $("#fp_msg2").html("Please enter OTP");
                return;
            }

            $.post("/Admin/Home/ForgotPassword_VerifyOTP",
                { email: email, otp: otp },
                function (res) {
                    if (res.IsSuccess) {
                        clearInterval(fp_timerRef);
                        $("#fp_step2").hide();
                        $("#fp_step3").show();
                    } else {
                        $("#fp_msg2").html(res.Message);
                    }
                });
        });

        // RESEND OTP
        $("#fp_btn_resendotp").click(function () {
            let email = $("#fp_email").val().trim();

            $.post("/Admin/Home/ForgotPassword_SendOTP", { email: email }, function (res) {
                if (res.IsSuccess) {
                    $("#fp_msg2").removeClass("text-danger").addClass("text-success")
                                 .html("New OTP sent");
                    $("#fp_timerBlock").show();
                    $("#fp_btn_resendotp").prop("disabled", true);
                    startTimer();
                } else {
                    $("#fp_msg2").html(res.Message);
                }
            });
        });

        // RESET PASSWORD
        $("#fp_btn_resetpw").click(function () {
            let email = $("#fp_email").val().trim();
            let newPassword = $("#fp_newpassword").val().trim();
            let confirmPassword = $("#fp_confirmpassword").val().trim();

            $("#fp_msg3").removeClass("text-danger text-success");

            if (newPassword === "" || confirmPassword === "") {
                $("#fp_msg3").addClass("text-danger").html("All fields are required");
                return;
            }

            if (newPassword !== confirmPassword) {
                $("#fp_msg3").addClass("text-danger").html("Passwords do not match");
                return;
            }

            $(document).ready(function () {
                fnShowHidePassword();
            });

            $.post("/Admin/Home/ForgotPassword_ResetPassword",
                { email: email, newPassword: newPassword },
                function (res) {
                    if (res.IsSuccess) {
                        $("#fp_msg3").addClass("text-success")
                            .html("Password changed successfully. Redirecting...");
                        setTimeout(function () {
                            window.location.href = "/Admin/Home/Account";
                        }, 1500);
                    } else {
                        $("#fp_msg3").addClass("text-danger").html(res.Message);
                    }
                });
        });
        function fnShowHidePassword() {
            $("[data-password='true']").off("click").on("click", function () {
                var input = $(this).siblings("input");
                if (input.length === 0) {
                    // Sometimes the input is not a sibling, find the previous input
                    input = $(this).closest(".input-group").find("input");
                }
                if (input.attr("type") === "password") {
                    input.attr("type", "text");
                    $(this).find(".password-eye").addClass("view"); // optional class to change eye icon
                } else {
                    input.attr("type", "password");
                    $(this).find(".password-eye").removeClass("view");
                }
            });
        }

        // Call it on document ready

    </script>


</body>
</html>
