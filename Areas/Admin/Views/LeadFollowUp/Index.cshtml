@model ResponseModel<LeadFollowup>

@{
	ViewBag.Title = "Index";
	Layout = "~/Areas/Admin/Views/Shared/_Layout_Admin.cshtml";

}


@section Styles {
	<style type="text/css">
		.select2-container .select2-selection--multiple .select2-selection__rendered {
			display: contents !important;
		}
	</style>
}

<!-- start page title -->

<div class="row">
	<div class="col-12">
		<div class="page-title-box d-flex align-items-center justify-content-between mb-3">

			<!-- LEFT: LOST / WON -->
			<div class="d-flex align-items-center gap-2">
				<button type="button"
						class="btn btn-danger btn-md divformSave_Hide"
						onclick="fnUpdateStatus_Confirm_WithRemarks('Are you sure you want to mark this lead as Lost?','Remarks','Remarks','@Model.Obj.LeadId','LOST');">
					<i class="bi bi-x-circle"></i> Lost
				</button>

				<button type="button"
						class="btn btn-success btn-md divformSave_Hide"
						onclick="fnUpdateStatus_Confirm('@Url.Action("LeadStatus_Change", "LeadFollowUp", new { area = "Admin" })?Id=@Model.Obj.LeadId&Status=WON','Are you sure you want to mark this lead as Won?');" ">
					<i class="bi bi-check-circle"></i> Won
				</button>
			</div>

			<!-- CENTER: TITLE -->
			<h4 class="page-title mb-0 text-center flex-grow-1">
				Lead Follow Ups
			</h4>
			
			<!-- RIGHT: ADD / BACK -->
			<div class="d-flex align-items-center gap-2">
				@if(Model.Obj.Status == "NEW"||Model.Obj.Status == "INPROC")
				{
					<button type="button"
							class="btn btn-primary btn-md  divformSave_Hide"
							onclick="fnLoadParialView(
	                    'divformSave',
	                    '@Url.Action("Partial_AddEditForm", "LeadFollowUp", new { area = "Admin" })?LeadId=@Model.Obj.LeadId&Status=@Model.Obj.Status'
	                );">
						<i class="bi bi-plus-circle"></i> Add New
					</button>
				}
				

				<button type="button"
						class="btn btn-primary btn-md divformSave_Hide"
						onclick="fnBackToList('@Url.Action("Index", "Lead")');">
					<i class="bi bi-arrow-left-circle"></i> Back To List
				</button>
			</div>

		</div>

	</div>
</div>
<!-- end page title -->

<div class="row">
	<div class="col-12">
		<div class="card">
			<div class="card-header p-0 divformSave_Display d-none">
				<form id="formSave" action="@Url.Action("Save", "LeadFollowUp", new { area = "Admin" })" method="post">
					<div class="row no-gutters" id="divformSave"></div>
				</form>
			</div>
			<div class=" card-header divformSave_Hide">
				<div class="form-group row">
					<label for="Name" class="col-2 col-form-label text-end">Lead Name </label>
					<div class="col-sm-4">
						<input type="text" class="form-control form-control-sm" id="Name" name="Name" value="@Model.Obj.Name"
							   placeholder="PropertyTypes" autocomplete="off" disabled>
					</div>
				</div>

			</div>
			<div class="card-body divformSave_Hide">
				<div class="row no-gooters">
					<div class="col-md-12 my-1">
						<div class="responsive-table-plugin">
							<div class="table-rep-plugin">
								<div class="table-responsive" data-pattern="priority-columns">
									<table class="table table-sm table-bordered table-striped dt-responsive nowrap w-100 table_Common_SrNo">
										<thead>
											<tr>
												<th>Sr.No</th>
												<th>Next Follow Up Date</th>												
												<th>Remarks</th>
												@if (Model.Obj.Status == "NEW" || Model.Obj.Status == "INPROC")
												{
													<th>Action</th>
												}
											</tr>
										</thead>
										<tbody>
											@if (Model.ObjList != null)
											{
												foreach (var item in Model.ObjList.OrderBy(x => x.Id))
												{
													<tr>
														<td></td>
														<td>@item.NextFollowupDate?.ToString(Common.DateTimeFormat_ddMMMyyyy)</td>														
														<td>@item.Remark</td>
														@if (Model.Obj.Status == "NEW" || Model.Obj.Status == "INPROC")
														{
															<td>
																<div class="btn-group">


																	<button type="button" class="btn btn-info btn-sm btn-flat" data-toggle="tooltip" data-placement="top" title="Edit"
																			onclick="fnLoadParialView('divformSave', '@Url.Action("Partial_AddEditForm", "LeadFollowUp", new { area = "Admin" })?Id=@item.Id&LeadId=@item.LeadId&Status=@Model.Obj.Status');">
																		<i class="ri-pencil-fill"></i>
																	</button>


																	@* <button type="button" class="btn btn-danger btn-sm btn-flat ml-2" data-toggle="tooltip" data-placement="top" title="Delete"
																		onclick="fnDelete_Confirm('@Url.Action("DeleteConfirmed", "LeadFollowUp", new { area = "Admin" })?Id=@item.Id&ParentId=@item.ParentId');">
																	<i class="ri-delete-bin-2-line"></i>
																</button> *@

																</div>
															</td>
														}
													</tr>
												}
											}
										</tbody>
									</table>
								</div> <!-- end .table-responsive -->

							</div> <!-- end .table-rep-plugin-->
						</div> <!-- end .responsive-table-plugin-->
					</div>

					<div class="clearfix"></div>
				</div>
			</div> <!-- end card body-->
		</div> <!-- end card -->
	</div><!-- end col-->
</div> <!-- end row-->
@section Scripts {
	<script type="text/javascript">
		$(document).ready(function () {

		});

		function fnUpdateStatus_Confirm_WithRemarks(confirmMessage, promptTitle, promptMessage , LeadId , Status) {

			Swal.fire({
				icon: "warning",
				title: confirmMessage,
				showCancelButton: true,
				confirmButtonColor: '#3085d6',
				cancelButtonColor: '#d33',
				confirmButtonText: 'Yes!'
			}).then((confirmResult) => {

				if (!confirmResult.isConfirmed) return;

				Swal.fire({
					title: promptTitle,
					text: promptMessage,
					input: 'text',
					inputPlaceholder: 'Enter remarks...',
					showCancelButton: true,
					confirmButtonText: 'Submit',
					confirmButtonColor: '#3085d6',
					cancelButtonColor: '#d33',
					showLoaderOnConfirm: true,
					preConfirm: (remarks) => {
					if (!remarks || remarks.trim().length === 0) {
					
					Swal.showValidationMessage('Remarks are required');
					return false;
				    }
						return remarks;
					}
				}).then((promptResult) => {

					if (!promptResult.isConfirmed) return;

					ShowLoader(true);

					$.ajax({
						type: "POST",
						url: '@Url.Action("LeadStatus_Change", "LeadFollowUp")',
						data: { Id: LeadId , Status:Status , Remarks: promptResult.value},
						success: function (response) {
							ShowLoader(false);

							try {
								if (response.StatusCode === 1) {

									if (response.IsConfirm === true) {
										if (response.RedirectURL)
											CommonConfirmed_Success(response.Message, response.RedirectURL, null);
										else
											CommonConfirmed_Success(response.Message, fnDelete_Success, [response]);
									}
									else {
										if (response.RedirectURL)
											window.location = response.RedirectURL;
										else
											fnDelete_Success(response);
									}
								}
								else {
									CommonAlert_Error(response.Message, null);
								}
							} catch {
								window.location.reload();
							}
						},
						error: function () {
							ShowLoader(false);
							CommonAlert_Error(null);
						}
					});
				});
			});
		}
		// function fnChange_Select($id) {


		// 	var selectedValue = $('#select' + $id).val();

		// 	if (typeof selectedValue != 'undefined' && selectedValue != null && selectedValue != '' && selectedValue.length > 0)
		// 		$('#input' + $id).val(selectedValue.join(','));
		// 	else
		// 		$('#input' + $id).val('');

		// 	$('#input' + $id).trigger('change');
		// }

		//function fnChange_Checkbox($this) {
		//

		//    var selectedValue = $('#selectedMenu').val();

		//    if (selectedValue == 'undefined' || selectedValue == null)
		//        selectedValue = "";

		//    if ($this.checked && selectedValue.indexOf($this.value) == -1) {
		//        selectedValue = selectedValue + $this.value + ",";
		//    }
		//    else if (!$this.checked && selectedValue.indexOf($this.value) > -1) {
		//        selectedValue = selectedValue.replace($this.value + ",", "");
		//        selectedValue = selectedValue.replace($this.value, "");
		//    }

		//    $('#selectedMenu').val(selectedValue);
		//    $('#selectedMenu').trigger('change');
		//}

	</script>
}


