@using Broker.Infra
@model ResponseModel<LoginViewModel>
@{
	ViewData["Title"] = "Home Page";
}

@section Styles {
	<style type="text/css">
		.error {
			display: block !important;
		}

		.form-label {
			margin-bottom: 0 !important;
		}

		.form-control {
			font-size: 16px;
			line-height: 26px;
			background-color: #fff;
			border: 0;
			border-bottom: 1px solid #e7e7e7;
			border-radius: 0;
			font-weight: bold;
			margin-bottom: 7px;
		}

		.shadow {
			box-shadow: var(--bs-box-shadow) !important;
		}

		.nav-pills .nav-link.active {
			border-bottom: 3px solid #38bdf8 !important;
			border-radius: 0 !important;
			background: transparent !important;
			color: #38bdf8 !important;
		}
	</style>
}

<section class="position-relative mt-5 pt-4">
	<div class="container-fluid px-md-4 px-2 mt-2">
		<div class="bg-home-one d-table w-100 shadow rounded-3 overflow-hidden" id="home">
			<div class="bg-overlay image-wrap" id="hero-images"></div>
			<div class="bg-overlay bg-black opacity-50"></div>

			<div class="container">
				<div class="row justify-content-center">
					<div class="col-12">
						<div class="title-heading">
							<h4 class="heading fw-bold text-white title-dark mb-3">We will help you find <br> your <span class="typewrite text-primary" data-period="2000" data-type='[ "Wonderful", "Dream" ]'></span> home</h4>
							<p class="para-desc text-white title-dark mb-0">A reliable marketplace for buying, and renting properties with our support.</p>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</section>

<section class="section pt-5">
	<div class="container">
		<div class="row justify-content-center">
			<div class="col-12 mt-sm-0 pt-sm-0">
				<div class="features-absolute">
					<ul class="nav nav-pills bg-white border-bottom p-3 flex-row d-md-inline-flex mb-0 rounded-top-3 position-relative overflow-hidden" id="pills-tab" role="tablist">

						@if (Model.SelectListItems != null)
						{
							var category = Model.SelectListItems.Where(x => x.Group == "PC").OrderBy(x => x.OrderBy == null || x.OrderBy == 0).ThenBy(x => x.OrderBy).ToList();

							for (int i = 0; i < category.Count(); i++)
							{
								<li class="nav-item m-1 shadow">
									<a class="nav-link py-2 px-4 @(i == 0 ? "active" : "") rounded-3 fw-medium" id="@category[i].Value" data-bs-toggle="pill" href="#" role="tab" aria-controls="@category[i].Value" aria-selected="false">
										@category[i].Text
									</a>
								</li>

							}
						}
					</ul>

					<div class="bg-white rounded-bottom-3 rounded-end-3 sm-rounded-0">
						<div class="card border-0 bg-transparent">
							<form class="card-body text-start shadow" style="border-radius: 26px; box-shadow: 0 3px 12px -9px rgba(0, 0, 0, 0.4); border: solid 1px #38bdf8; background-color: #ffffff;">
								<div class="registration-form text-dark text-start">
									<div class="row g-lg-0">
										<div class="col-lg-4 col-md-6 col-12">
											<div class="mb-3 text-start">
												<div class="filter-search-form position-relative filter-border">
													<select class="form-select choices-select" id="choices-PropertyLocation">
														<option value="0">Select Location</option>
														@if (Model.SelectListItems != null)
														{
															foreach (var item in Model.SelectListItems.Where(x => x.Group == "L"))
															{
																<option value="@item.Value">@item.Text</option>
															}
														}
													</select>
												</div>
											</div>
										</div>

										<div class="col-lg-3 col-md-6 col-12">
											<div class="mb-3 text-start">
												<div class="filter-search-form position-relative filter-border">
													<select class="form-select choices-select" id="choices-PropertyType_Parent">
														<option value="0">Select Type</option>
														@if (Model.SelectListItems != null)
														{
															foreach (var item in Model.SelectListItems.Where(x => x.Group == "PT" && int.TryParse(x.Value2, out var z) && z <= 0))
															{
																<option value="@item.Value">@item.Text</option>
															}
														}
													</select>
												</div>
											</div>
										</div>

										<div class="col-lg-3 col-md-6 col-12">
											<div class="mb-3 text-start">
												<div class="filter-search-form position-relative">
													<select class="form-select choices-select" id="choices-PropertyType">
														<option value="0">Select Sub-Type</option>
														@if (Model.SelectListItems != null)
														{
															foreach (var item in Model.SelectListItems.Where(x => x.Group == "PT" && int.TryParse(x.Value2, out var z) && z > 0))
															{
																<option value="@item.Value" data-parent="@item.Value2">@item.Text</option>
															}
														}
													</select>
												</div>
											</div>
										</div>

										<div class="col-lg-2 col-md-6 col-12 align-self-end justify-content-center">
											<div class="mb-3 text-start">
												<div class="filter-search-form position-relative">
													<button type="button" class="btn btn-primary ms-md-5" data-bs-toggle="modal" data-bs-target="#exampleModalCenteredScrollable"
															style="height: 60px; font-size: 20px; font-weight: 600;">
														Search
													</button>
												</div>
											</div>
										</div>

									</div>
								</div>
							</form>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<div class="container mt-100 mt-60">
		<div class="row justify-content-center">
			<div class="col">
				<div class="section-title mb-4 pb-2">
					<h4 class="title mb-3">Listing Categories</h4>
				</div>
			</div>
		</div>
		<div class="row row-cols-lg-5 row-cols-md-3 row-cols-sm-2 row-cols-1 g-4 mt-0">
			@if (Model.Data1 != null)
			{
				foreach (PropertyType item in ((Model.Data1 as IList<PropertyType>)?.OrderBy(x => x.Display_Seq_No).ToList()))
				{
					<div class="col property-type position-relative" role="button" id="itemProperty_@item.Id"
						 onclick="@((Model.SelectListItems != null && Model.SelectListItems.Any(x => x.Group == "PT" && int.TryParse(x.Value2, out var z) && z > 0 && z == item.Id)) ? "openPropertyCollapse(this)" : $"openPropertyModal({@item.Id}, 0)")">
						<div class="categories position-relative overflow-hidden rounded-3 shadow">
							<div class="collapse collapse-horizontal w-100" data-bs-parent="#itemProperty_@item.Id" id="collapseWidthExample_@item.Id">
								<div class="card card-body bg-transparent">
									<ul class="list-unstyled property-icon">
										@if (Model.SelectListItems != null && Model.SelectListItems.Any(x => x.Group == "PT" && int.TryParse(x.Value2, out var z) && z > 0 && z == item.Id))
										{
											foreach (var _item in Model.SelectListItems.Where(x => x.Group == "PT" && int.TryParse(x.Value2, out var z) && z > 0 && z == item.Id))
											{
												<li class="list-group-item d-flex justify-content-between align-items-start" onclick="openPropertyModal(@item.Id, @_item.Value)">
													<div class="btn btn-sm btn-icon btn-primary m-1 me-auto w-100 ">
														<div class="fw-bold">@_item.Text</div>
													</div>
													@* <span class="badge text-bg-primary rounded-pill">14</span> *@
												</li>
											}
										}
									</ul>
								</div>
							</div>
							@if (!string.IsNullOrEmpty(item.ImagePath))
							{
								<img src="@Url.Content("~/" + item.ImagePath)" class="img-fluid" alt="" style="width:204px; height:140px">
							}
							else
							{
								<img src="~/no_image_available.png" class="img-fluid" alt="" style="width:204px; height:140px">
							}

							<div class="p-3">
								<span class="title text-dark fs-5 fw-medium">@item.Name</span>
								<p class="text-muted small mb-0">@item.PropertyCount @(item.PropertyCount > 1 ? "Properties" : "Property")</p>
							</div>

						</div>
					</div>
				}
			}

		</div>
	</div>

	<div class="container mt-100 mt-60">
		<div class="row justify-content-center">
			<div class="col">
				<div class="section-title text-center mb-4 pb-2">
					<h4 class="title mb-3">How It Works</h4>
					<p class="text-muted para-desc mb-0 mx-auto">A simple platform that makes buying and renting properties easy, with expert help and a smooth experience from start to finish.</p>
				</div>
			</div>
		</div>

		<div class="row g-4 mt-0">
			<div class="col-md-4">
				<div class="position-relative features text-center mx-lg-4 px-md-1">
					<div class="feature-icon position-relative overflow-hidden d-flex justify-content-center">
						<i data-feather="hexagon" class="hexagon"></i>
						<div class="position-absolute top-50 start-50 translate-middle">
							<i data-feather="home" class="fea icon-m-md text-primary"></i>
						</div>
					</div>

					<div class="mt-4">
						<a href="" class="fw-medium title text-dark fs-5">Check Property</a>
						<p class="text-muted mt-3 mb-0">Take your time to explore property details and location so you can feel confident about your choice.</p>
					</div>
				</div>
			</div>

			<div class="col-md-4">
				<div class="position-relative features text-center mx-lg-4 px-md-1">
					<div class="feature-icon position-relative overflow-hidden d-flex justify-content-center">
						<i data-feather="hexagon" class="hexagon"></i>
						<div class="position-absolute top-50 start-50 translate-middle">
							<i data-feather="briefcase" class="fea icon-m-md text-primary"></i>
						</div>
					</div>

					<div class="mt-4">
						<a href="" class="fw-medium title text-dark fs-5">Talk to Agent</a>
						<p class="text-muted mt-3 mb-0">Connect with a friendly, experienced agent who can answer your questions and guide you through the process.</p>
					</div>
				</div>
			</div>

			<div class="col-md-4">
				<div class="position-relative features text-center mx-lg-4 px-md-1">
					<div class="feature-icon position-relative overflow-hidden d-flex justify-content-center">
						<i data-feather="hexagon" class="hexagon"></i>
						<div class="position-absolute top-50 start-50 translate-middle">
							<i data-feather="key" class="fea icon-m-md text-primary"></i>
						</div>
					</div>

					<div class="mt-4">
						<a href="" class="fw-medium title text-dark fs-5">Finalize Deal</a>
						<p class="text-muted mt-3 mb-0">Complete the paperwork, confirm the details, and move forward knowing everything is handled smoothly and securely.</p>
					</div>
				</div>
			</div>
		</div>
	</div>

</section><!--end section-->
<!-- End -->

<div class="modal fade" id="exampleModalCenteredScrollable" tabindex="-1" aria-labelledby="exampleModalCenteredScrollableTitle" aria-hidden="true">
	<div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
		<div class="modal-content">
			<div class="modal-header">
				<h1 class="modal-title fs-5" id="exampleModalCenteredScrollableTitle">Please fill out your basic details in this form</h1>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" tabindex="-1"></button>
			</div>
			<div class="modal-body">
				<form id="formUserData" action="@Url.Action("Search", "Home", new { area = "" })" class="needs-validation" novalidate="">
					<div class="row g-3">
						<div class="col-sm-6">
							<label for="firstName" class="form-label">First name</label>
							<input type="text" class="form-control" name="FirstName" id="firstName" data-required data-msg="Please enter First name" tabindex="1">
						</div>
						<div class="col-sm-6">
							<label for="lastName" class="form-label">Last name</label>
							<input type="text" class="form-control" name="LastName" id="lastName" data-required data-msg="Please enter Last name" tabindex="2">
						</div>
						<div class="col-12">
							<label for="email" class="form-label">Email <span class="text-body-secondary">(Optional)</span></label>
							<input type="email" class="form-control" name="Email" id="email" placeholder="you@example.com" data-required data-msg="Please enter Email" tabindex="3">
						</div>
						<div class="col-12">
							<label for="ContactNo" class="form-label">Contact No.</label>
							<input type="text" class="form-control isNumberKey" name="ContactNo" id="ContactNo" maxlength="11" data-required data-msg="Please enter Contact No." tabindex="4">
						</div>
					</div>
				</form>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-primary" onclick="fnSubmitFormHere('formUserData')" tabindex="5">Submit</button>
				<button type="button" class="btn btn-secondary" data-bs-dismiss="modal" tabindex="6">Close</button>
			</div>
		</div>
	</div>
</div>


@section Scripts {
	<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/jquery-validation@1.19.5/dist/jquery.validate.min.js"></script>
	<script type="text/javascript">
		const modalEl = document.getElementById('exampleModalCenteredScrollable');

		modalEl.addEventListener('show.bs.modal', function (event) {

			if (event.relatedTarget) {
				modalEl.dataset.openSource =
					event.relatedTarget.dataset.openSource || 'search-button';
			}
		});


		$(document).on('click',function (e) {
			if ($(e.target).closest('.property-type').length > 0) { return; }

			$('div[id^="collapseWidthExample_"]').each(function () {
				$(this).removeClass('position-absolute');
				$(this).removeClass('d-block');
			});
		});


		function openPropertyCollapse(el) {
			debugger;

			$('div[id^="collapseWidthExample_"]').each(function () {
				$(this).removeClass('position-absolute');
				$(this).removeClass('d-block');
			});

			$(el).find('.collapse').addClass('position-absolute');
			$(el).find('.collapse').addClass('d-block');

		}


		function openPropertyModal(ParentTypeId, TypeId) {
			debugger;

			const modalEl = document.getElementById('exampleModalCenteredScrollable');

			modalEl.dataset.openSource = 'property-type';
			modalEl.dataset.parentTypeId = ParentTypeId;
			modalEl.dataset.typeId = TypeId;

			const modal = new bootstrap.Modal(modalEl);
			modal.show();
		}

		// function openPropertyModal(el) {
		// 	const modalEl = document.getElementById('exampleModalCenteredScrollable');

		// 	modalEl.dataset.openSource = 'property-type';
		// 	modalEl.dataset.propertyTypeId = el.dataset.propertyTypeId;

		// 	const modal = new bootstrap.Modal(modalEl);
		// 	modal.show();
		// }


		function fnSubmitFormHere(formId) {

			const $form = $('#' + formId);
			const modalEl = document.getElementById('exampleModalCenteredScrollable');
			const source = modalEl.dataset.openSource;

			// ---- VALIDATE USER FORM (always required) ----
			$form.validate({
				rules: {
					FirstName: { required: true },
					LastName: { required: true },
					Email: { required: true },
					ContactNo: { required: true }
				}
			});

			if (!$form.valid()) return;

			// ---- COMMON VALUES ----
			let location = '';
			let category = '';
			let typeParent = '';
			let type = '';

			// ---- DIFFERENCE BASED ON SOURCE ----
			if (source === 'property-type') {
				// ✅ Type already selected
				typeParent = modalEl.dataset.parentTypeId;
				type = modalEl.dataset.typeId;
			} else {
				// ✅ Search button flow → validate selects
				typeParent = $('#choices-PropertyType_Parent').val();
				type = $('#choices-PropertyType').val();

				location = $('#choices-PropertyLocation').val();
				category = $('#pills-tab .nav-link.active').attr('id');

				if (!location || !category || !type) {
					showToast('Please select all search filters', 'danger', 5000);
					return;
				}
			}
			debugger;
			// ---- BUILD URL ----
			const query = $form.serialize();

			// const url =
			// 	`@Url.Action("Properties", "Home")?${query}` +
			// 	`&Location=${encodeURIComponent(location)}` +
			// 	`&PropertyCategory=${encodeURIComponent(category)}` +
			// 	`&PropertyType_Parent=${encodeURIComponent(typeParent)}` +
			// 	`&PropertyType=${encodeURIComponent(type)}`;

		const url = `@Url.Action("Properties", "Home")`;

		fetch(url, { 
			method: 'GET',
			headers: {
				'FirstName': $('#firstName').val() || '',
				'LastName': $('#lastName').val() || '',
				'Email': $('#email').val() || '',
				'ContactNo': $('#ContactNo').val() || '',
				'Location': location,
				'PropertyCategory': category,
				'PropertyType_Parent': typeParent,
				'PropertyType': type
			} 
		})
		.then(async response =>
		{
			debugger;
			if (!response.ok) {
				let errorBody = null;

				try {
					errorBody = await response.json(); // 👈 read body
					showToast(errorBody.Message, 'danger', 5000);
					return; // stop here
				} catch {
					// response is not JSON
				}

			}

			// ✅ Response is OK → redirect
			//window.location.href = url;
			else return response.text(); // HTML
		})
		.then(html => {
			debugger;
			document.open();
			document.write(html);
			document.close();
		})
		.catch(err => {debugger;
			showToast('Opps!... Something went wrong', 'danger', 5000);
		});



		}

		document.querySelectorAll('.choices-select:not([data-choices-init])')
		  .forEach(el => {
			const instance = new Choices(el, {
			  searchEnabled: true,
			  removeItemButton: true,
			});

			el._choicesInstance = instance;

			el.setAttribute('data-choices-init', 'true');
		  });

		let childChoices;

		const childSelect = document.getElementById('choices-PropertyType');
		const originalOptions = Array.from(childSelect.options).map(o =>
		  o.cloneNode(true)
		);

		document
		.getElementById('choices-PropertyType_Parent')
		.addEventListener('change', function () {
		  const selectedParent = this.value;

		  var filterd = originalOptions.filter(o => o.dataset.parent === selectedParent).map(o => ({ value: o.value, label: o.text, }));

			const choices = childSelect._choicesInstance;

			choices.clearChoices();
			choices.removeActiveItems();
			choices.setChoices(filterd, 'value', 'label', true );

		});
	</script>
}